# Node 1 Galera configuration.
# Reference: https://mariadb.com/docs/galera-cluster/readme/mariadb-galera-cluster-usage-guide
[mysqld]

# Standard MariaDB settings required for Galera
binlog_format=ROW
default_storage_engine=InnoDB
innodb_autoinc_lock_mode=2
bind-address=0.0.0.0
server-id=1
log-error=/var/lib/mysql/galera1.err

# Galera replication settings
wsrep_on=ON
wsrep_provider=/usr/lib/galera/libgalera_smm.so
wsrep_cluster_name=passbolt_galera

# Bootstrap node uses empty address list to form Primary Component on first start.
# A Primary Component is the majority group (more than 50% of nodes) that can process transactions.
# Nodes not in the Primary Component enter a non-primary state (read-only) and halt query processing
# to prevent data discrepancies. This prevents split-brain scenarios where network partitions
# could cause conflicting writes.
#
# IMPORTANT: The empty gcomm:// is only for the FIRST bootstrap. If you restart galera1 while
# other nodes are running, it will try to bootstrap and fail (safe_to_bootstrap: 0). In that case,
# comment out the empty gcomm:// line below and uncomment the full address list so it joins the
# existing cluster instead.
#
# Why empty gcomm://? With a full address list, Galera tries to connect to peers first. If they
# don't exist, it enters NON_PRIM state and won't bootstrap. Empty gcomm:// tells it to bootstrap
# immediately when the datadir is empty.
#
# In production, list all peer FQDNs: gcomm://galera1.example.com,galera2.example.com,galera3.example.com
# In this lab, we use .local aliases (defined in docker-compose.yaml) which match the certificate SANs.
wsrep_cluster_address=gcomm://
# After first bootstrap, uncomment the line below and comment out the empty gcomm:// above:
# wsrep_cluster_address=gcomm://galera1.local,galera2.local,galera3.local
wsrep_node_name=galera1

# Node's advertised address for replication traffic (port 4567 is Galera's default).
# When deploying outside Docker, set this to the node's routable IP or FQDN.
# In this lab we resolve galera1.local via /etc/hosts to 127.0.0.1.
wsrep_node_address=galera1.local:4567

# State Snapshot Transfer method.
# rsync is the default and fastest method for large datasets.
# SST encryption is out of scope for this lab (SST is for catastrophic recovery scenarios).
wsrep_sst_method=rsync
wsrep_sst_receive_address=galera1:4444

# Mutual TLS (mTLS) for Galera replication traffic.
# These certificates enable node-to-node authentication and encryption.
# Each node presents its server certificate and verifies peers using the CA.
# This is mTLS because both sides authenticate each other, not just the client checking the server.
# GCache size: Larger GCache allows nodes to be offline longer and still use IST instead of SST.
# Default is 128M. For production, size based on write rate and desired offline tolerance.
# Example: 1GB allows ~1 hour of offline time at moderate write rates before falling back to SST.
wsrep_provider_options="socket.ssl_cert=/etc/mysql/ssl/server-cert.pem;socket.ssl_key=/etc/mysql/ssl/server-key.pem;socket.ssl_ca=/etc/mysql/ssl/ca.pem;gcache.size=512M"

# TLS for client connections (Passbolt application).
# These are the server-side certificates that clients verify.
ssl-ca=/etc/mysql/ssl/ca.pem
ssl-cert=/etc/mysql/ssl/server-cert.pem
ssl-key=/etc/mysql/ssl/server-key.pem

# Require TLS for all client connections. Passbolt must present a client certificate (mTLS).
# The client certificate requirement is enforced via ALTER USER in 02-enforce-ssl.sql.
require_secure_transport=ON

skip-name-resolve=ON
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci

